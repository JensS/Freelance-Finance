version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${APP_PORT:-8080}:80"
    environment:
      # Application
      APP_NAME: "${APP_NAME:-Freelance Finance Hub}"
      APP_ENV: "${APP_ENV:-production}"
      APP_KEY: "${APP_KEY}"
      APP_DEBUG: "${APP_DEBUG:-false}"
      APP_URL: "${APP_URL:-http://localhost}"
      APP_PASSWORD: "${APP_PASSWORD}"

      # Database (External PostgreSQL)
      DB_CONNECTION: pgsql
      DB_HOST: "${DB_HOST}"
      DB_PORT: "${DB_PORT:-5432}"
      DB_DATABASE: "${DB_DATABASE}"
      DB_USERNAME: "${DB_USERNAME}"
      DB_PASSWORD: "${DB_PASSWORD}"

      # Cache & Queue
      CACHE_DRIVER: "${CACHE_DRIVER:-file}"
      QUEUE_CONNECTION: "${QUEUE_CONNECTION:-database}"
      SESSION_DRIVER: "${SESSION_DRIVER:-file}"

      # AI Provider Configuration
      OLLAMA_API_URL: "${OLLAMA_API_URL:-http://host.docker.internal:11434}"
      AI_PROVIDER: "${AI_PROVIDER:-ollama}"
      AI_FALLBACK_PROVIDER: "${AI_FALLBACK_PROVIDER:-none}"

      # OpenAI
      OPENAI_API_KEY: "${OPENAI_API_KEY:-}"
      OPENAI_MODEL: "${OPENAI_MODEL:-gpt-4o}"

      # Anthropic (Claude)
      ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY:-}"
      ANTHROPIC_MODEL: "${ANTHROPIC_MODEL:-claude-3-5-sonnet-20241022}"

      # OpenRouter
      OPENROUTER_API_KEY: "${OPENROUTER_API_KEY:-}"
      OPENROUTER_MODEL: "${OPENROUTER_MODEL:-anthropic/claude-3.5-sonnet}"

      # Paperless Integration
      PAPERLESS_URL: "${PAPERLESS_URL}"
      PAPERLESS_API_TOKEN: "${PAPERLESS_API_TOKEN}"

      # Logging
      LOG_CHANNEL: "${LOG_CHANNEL:-stack}"
      LOG_LEVEL: "${LOG_LEVEL:-error}"

    volumes:
      # Persistent storage for uploads, logs, and cache
      - storage_data:/app/storage/app
      - storage_logs:/app/storage/logs
      - storage_framework:/app/storage/framework

    networks:
      - app_network
      # Connect to external PostgreSQL network if needed
      - postgres_network

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/up"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

    depends_on:
      - postgres

  # PostgreSQL service (if not using external database)
  # Comment this out if using Dokploy's shared PostgreSQL instance
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: "${DB_DATABASE}"
      POSTGRES_USER: "${DB_USERNAME}"
      POSTGRES_PASSWORD: "${DB_PASSWORD}"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - postgres_network
    restart: unless-stopped
    profiles:
      - local
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME}"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  app_network:
    driver: bridge
  postgres_network:
    # For Dokploy: use external network to connect to shared PostgreSQL
    # Uncomment the following and comment out 'driver: bridge'
    # external: true
    # name: postgres_network
    driver: bridge

volumes:
  storage_data:
    driver: local
  storage_logs:
    driver: local
  storage_framework:
    driver: local
  postgres_data:
    driver: local
